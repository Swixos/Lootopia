# GitLab CI/CD Pipeline pour Lootopia
# Documentation: https://docs.gitlab.com/ee/ci/

# Variables globales
variables:
  NODE_VERSION: "20"
  PNPM_VERSION: "10.25.0"
  DOCKER_DRIVER: overlay2
  DOCKER_TLS_CERTDIR: "/certs"
  # Cache pnpm
  PNPM_HOME: "${CI_PROJECT_DIR}/.pnpm-store"
  # Désactiver les analytics
  DISABLE_OPENCOLLECTIVE: "true"
  DISABLE_TELEMETRY: "true"

# Étapes du pipeline
stages:
  - install
  - lint
  - test
  - build
  - security
  - deploy

# Template de base pour les jobs Node.js
.node-base:
  image: node:${NODE_VERSION}-alpine
  before_script:
    - corepack enable
    - corepack prepare pnpm@${PNPM_VERSION} --activate
    - pnpm config set store-dir ${PNPM_HOME}
  cache:
    key:
      files:
        - pnpm-lock.yaml
    paths:
      - ${PNPM_HOME}
      - node_modules/
      - apps/*/node_modules/
    policy: pull

# ============================================
# STAGE: INSTALL - Installation des dépendances
# ============================================

install:dependencies:
  stage: install
  extends: .node-base
  cache:
    key:
      files:
        - pnpm-lock.yaml
    paths:
      - ${PNPM_HOME}
      - node_modules/
      - apps/*/node_modules/
    policy: pull-push
  script:
    - pnpm install --frozen-lockfile
  artifacts:
    paths:
      - node_modules/
      - apps/backend/node_modules/
      - apps/frontend/node_modules/
    expire_in: 1 hour
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
    - if: $CI_COMMIT_BRANCH =~ /^develop$/
    - if: $CI_COMMIT_BRANCH =~ /^claude\/.*/

# ============================================
# STAGE: LINT - Vérification du code
# ============================================

lint:eslint:
  stage: lint
  extends: .node-base
  needs:
    - install:dependencies
  script:
    - pnpm lint
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
    - if: $CI_COMMIT_BRANCH =~ /^develop$/
    - if: $CI_COMMIT_BRANCH =~ /^claude\/.*/

lint:prettier:
  stage: lint
  extends: .node-base
  needs:
    - install:dependencies
  script:
    - pnpm format:check
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
    - if: $CI_COMMIT_BRANCH =~ /^develop$/
    - if: $CI_COMMIT_BRANCH =~ /^claude\/.*/

# ============================================
# STAGE: TEST - Tests unitaires et e2e
# ============================================

test:backend:unit:
  stage: test
  extends: .node-base
  needs:
    - install:dependencies
  services:
    - name: mariadb:11.6
      alias: database
  variables:
    MYSQL_ROOT_PASSWORD: test_root_password
    MYSQL_DATABASE: lootopia_test
    MYSQL_USER: lootopia_test
    MYSQL_PASSWORD: test_password
    DB_HOST: database
    DB_PORT: "3306"
    DB_DATABASE: lootopia_test
    DB_USER: lootopia_test
    DB_PASSWORD: test_password
    JWT_SECRET: test_jwt_secret_for_ci
    NODE_ENV: test
  script:
    - cd apps/backend
    - pnpm test --coverage
  coverage: '/All files[^|]*\|[^|]*\s+([\d\.]+)/'
  artifacts:
    when: always
    reports:
      coverage_report:
        coverage_format: cobertura
        path: apps/backend/coverage/cobertura-coverage.xml
      junit: apps/backend/coverage/junit.xml
    paths:
      - apps/backend/coverage/
    expire_in: 30 days
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
    - if: $CI_COMMIT_BRANCH =~ /^develop$/
    - if: $CI_COMMIT_BRANCH =~ /^claude\/.*/

test:backend:e2e:
  stage: test
  extends: .node-base
  needs:
    - install:dependencies
  services:
    - name: mariadb:11.6
      alias: database
  variables:
    MYSQL_ROOT_PASSWORD: test_root_password
    MYSQL_DATABASE: lootopia_test
    MYSQL_USER: lootopia_test
    MYSQL_PASSWORD: test_password
    DB_HOST: database
    DB_PORT: "3306"
    DB_DATABASE: lootopia_test
    DB_USER: lootopia_test
    DB_PASSWORD: test_password
    JWT_SECRET: test_jwt_secret_for_ci
    NODE_ENV: test
  script:
    - cd apps/backend
    - pnpm test:e2e
  artifacts:
    when: always
    paths:
      - apps/backend/test-results/
    expire_in: 7 days
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
    - if: $CI_COMMIT_BRANCH =~ /^develop$/

test:frontend:unit:
  stage: test
  extends: .node-base
  needs:
    - install:dependencies
  script:
    - cd apps/frontend
    - pnpm test --coverage
  coverage: '/All files[^|]*\|[^|]*\s+([\d\.]+)/'
  artifacts:
    when: always
    reports:
      coverage_report:
        coverage_format: cobertura
        path: apps/frontend/coverage/cobertura-coverage.xml
    paths:
      - apps/frontend/coverage/
    expire_in: 30 days
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
    - if: $CI_COMMIT_BRANCH =~ /^develop$/
    - if: $CI_COMMIT_BRANCH =~ /^claude\/.*/

# ============================================
# STAGE: BUILD - Compilation des applications
# ============================================

build:backend:
  stage: build
  extends: .node-base
  needs:
    - install:dependencies
    - lint:eslint
    - lint:prettier
    - test:backend:unit
  script:
    - pnpm --filter @lootopia/backend build
  artifacts:
    paths:
      - apps/backend/dist/
    expire_in: 7 days
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
    - if: $CI_COMMIT_BRANCH =~ /^develop$/

build:frontend:
  stage: build
  extends: .node-base
  needs:
    - install:dependencies
    - lint:eslint
    - lint:prettier
    - test:frontend:unit
  script:
    - pnpm --filter @lootopia/frontend build:prod
  artifacts:
    paths:
      - apps/frontend/dist/
    expire_in: 7 days
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
    - if: $CI_COMMIT_BRANCH =~ /^develop$/

# ============================================
# STAGE: SECURITY - Analyses de sécurité
# ============================================

security:dependency-scan:
  stage: security
  extends: .node-base
  needs:
    - install:dependencies
  script:
    - pnpm audit --audit-level=moderate || true
    - pnpm outdated || true
  allow_failure: true
  artifacts:
    when: always
    paths:
      - audit-report.txt
    expire_in: 30 days
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
    - if: $CI_COMMIT_BRANCH =~ /^develop$/

security:secret-detection:
  stage: security
  image: alpine:latest
  needs: []
  before_script:
    - apk add --no-cache git
  script:
    - echo "Scanning for secrets in the codebase..."
    - |
      git log --all --full-history --pretty=format:"%H" | while read commit; do
        git show $commit | grep -iE "(password|secret|token|api_key|private_key)" && echo "⚠️  Potential secret found in commit $commit" || true
      done
  allow_failure: true
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
    - if: $CI_PIPELINE_SOURCE == "schedule"

# Analyse SAST GitLab (nécessite GitLab Ultimate)
# Décommenter si vous avez GitLab Ultimate
# include:
#   - template: Security/SAST.gitlab-ci.yml
#   - template: Security/Secret-Detection.gitlab-ci.yml
#   - template: Security/Dependency-Scanning.gitlab-ci.yml
#   - template: Security/License-Scanning.gitlab-ci.yml

# ============================================
# STAGE: BUILD DOCKER - Images de production
# ============================================

build:docker:backend:
  stage: build
  image: docker:24-dind
  services:
    - docker:24-dind
  needs:
    - build:backend
  before_script:
    - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY
  script:
    - docker build -t $CI_REGISTRY_IMAGE/backend:$CI_COMMIT_SHORT_SHA -f apps/backend/Dockerfile .
    - docker build -t $CI_REGISTRY_IMAGE/backend:latest -f apps/backend/Dockerfile .
    - docker push $CI_REGISTRY_IMAGE/backend:$CI_COMMIT_SHORT_SHA
    - docker push $CI_REGISTRY_IMAGE/backend:latest
  rules:
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH

build:docker:frontend:
  stage: build
  image: docker:24-dind
  services:
    - docker:24-dind
  needs:
    - build:frontend
  before_script:
    - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY
  script:
    - docker build -t $CI_REGISTRY_IMAGE/frontend:$CI_COMMIT_SHORT_SHA -f apps/frontend/Dockerfile .
    - docker build -t $CI_REGISTRY_IMAGE/frontend:latest -f apps/frontend/Dockerfile .
    - docker push $CI_REGISTRY_IMAGE/frontend:$CI_COMMIT_SHORT_SHA
    - docker push $CI_REGISTRY_IMAGE/frontend:latest
  rules:
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH

# ============================================
# STAGE: DEPLOY - Déploiement
# ============================================

deploy:staging:
  stage: deploy
  image: alpine:latest
  needs:
    - build:docker:backend
    - build:docker:frontend
  environment:
    name: staging
    url: https://staging.lootopia.com
  before_script:
    - apk add --no-cache openssh-client
    - eval $(ssh-agent -s)
    - echo "$SSH_PRIVATE_KEY" | tr -d '\r' | ssh-add -
    - mkdir -p ~/.ssh
    - chmod 700 ~/.ssh
    - echo "$SSH_KNOWN_HOSTS" > ~/.ssh/known_hosts
    - chmod 644 ~/.ssh/known_hosts
  script:
    - |
      ssh $DEPLOY_USER@$DEPLOY_HOST_STAGING << 'EOF'
        cd /opt/lootopia
        docker-compose -f docker-compose.prod.yml pull
        docker-compose -f docker-compose.prod.yml up -d
        docker-compose -f docker-compose.prod.yml exec -T backend pnpm run migration:run || true
      EOF
  rules:
    - if: $CI_COMMIT_BRANCH =~ /^develop$/
      when: manual
  allow_failure: false

deploy:production:
  stage: deploy
  image: alpine:latest
  needs:
    - build:docker:backend
    - build:docker:frontend
  environment:
    name: production
    url: https://lootopia.com
  before_script:
    - apk add --no-cache openssh-client
    - eval $(ssh-agent -s)
    - echo "$SSH_PRIVATE_KEY" | tr -d '\r' | ssh-add -
    - mkdir -p ~/.ssh
    - chmod 700 ~/.ssh
    - echo "$SSH_KNOWN_HOSTS" > ~/.ssh/known_hosts
    - chmod 644 ~/.ssh/known_hosts
  script:
    - |
      ssh $DEPLOY_USER@$DEPLOY_HOST_PRODUCTION << 'EOF'
        cd /opt/lootopia
        docker-compose -f docker-compose.prod.yml pull
        docker-compose -f docker-compose.prod.yml up -d
        docker-compose -f docker-compose.prod.yml exec -T backend pnpm run migration:run || true
      EOF
  rules:
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
      when: manual
    - if: $CI_COMMIT_TAG =~ /^v\d+\.\d+\.\d+$/
      when: manual
  allow_failure: false

# ============================================
# Job de nettoyage (optionnel)
# ============================================

cleanup:old-pipelines:
  stage: .post
  image: alpine:latest
  script:
    - echo "Pipeline completed successfully!"
  rules:
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
